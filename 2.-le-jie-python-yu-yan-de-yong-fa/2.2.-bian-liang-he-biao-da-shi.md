# 2.2. 变量和表达式

变量是一段程序中存储数据的容器，我们先了解4种最基本的变量类型：布尔值、整数、浮点数、字符串。在Python语言中我们不需要事先指定变量的类型，而当一个变量被赋予某种类型的值后，它也可以被修改为或赋予其他类型的值，即Python是一种动态类型语言。

布尔值只有两种取值情况：真和假，分别写作

```
x = True   # 真值
x = False  # 假值
```

在将导入函数库的时候，我们只凭数学直觉理解了y=sin(x)的含义。现在我们正式定义赋值语句：以等于号分隔的程序语句即是赋值语句，左侧只能填写一个变量名，而右侧可以填写一个表达式，表达式可以包括值和运算符号。在这里True和False就是值，x是变量，变量类型取决于赋给它的值的类型。

{% hint style="info" %}
二元运算是指由两个元素形成第三个元素的一种规则，例如数的加法及乘法；更一般地，由两个集合形成第三个集合的产生方法或构成规则称为二元运算。
{% endhint %}

布尔值可以进行或、与、非运算。

**或运算：**二元运算符，任意一个条件为真，则输出真；两个条件都为假，则输出假。

**与运算：**二元运算符，只有两个条件都为真时才输出真，其他情况都输出假。

**非运算：**一元运算符，当输入为真时输出假，当输入假时输出真。

通过括号可以指定运算的优先级，和数学算式中括号的用法相同（但是无论嵌套多少层，都只能使用小括号）。或运算、与运算在默认情况下从左到右依此计算。我们可以观察以下例子得出这个结论：

```
>>> (True or False) and False
False
>>> True or (False and False)
True
>>> True or False and False
True
```

{% hint style="info" %}
这里我们首次使用了符号“>>>”。如果你在终端（命令提示符）中运行python.exe，会发现在每个可以输入的一行的行首，会有这样的先导符。出现先导符的时候，我们应该输入Python语言的语句（例如Hello world的例子），而没有先导符的时候，应该输入终端语言的语句（例如pip命令）。所以，我们在终端中编程时，Python语言的语句之前就自然有这样的先导符。

在本书关于程序语句的例子中，一种是整个代码块都没有>>>符号的，这沿用了在\*.py文件中编写程序的风格（但是不限制你以终端还是脚本文件的形式运行），你只能在运行完后看到被print输出的结果。另一种是包含>>>符号的代码块，沿用了在终端编程的风格，实现的时候不应该输入先导符。如果输入一个表达式或变量，终端会立刻显示表达式计算得的值或变量中储存的值；如果你在脚本文件中运行这种例子，可能无法直接看到结果，而要另外加一个print语句。
{% endhint %}

由于非运算是右结合的一元运算符，它只能出现在一段判断的开头。所以我们观察以下例子，可以发现非运算在默认情况下，只结合右侧最近的1个值。

```
>>> not (False or True)
False
>>> (not False) or True
True
>>> not False and True
True
```

产生逻辑值的一元运算有很多，例如整数0、浮点数0、空字符串，None，以及空的列表、元组、字典、集合（将在“数据结构”部分学习）都等于False，而其他值都等于True.

{% hint style="info" %}
将其他类型的变量转化成逻辑值时，应使用函数bool().
{% endhint %}

判断运算也可以产生逻辑值，常用的判断如表 1所示。判断运算也是二元运算，两边都可以是值、变量或表达式。

表 1 判断运算

| 不大于 | 不小于 | 大于 | 小于 | 等于 | 不等于 |
| --- | --- | -- | -- | -- | --- |
| <=  | >=  | >  | <  | == | !=  |

```
>>> a = 2
>>> b = 3
>>> a < b
True
```

比较大小的符号可以连续使用：

```
>>> 1 < 2 < 3  # 等价于 1 < 2 and 2 < 3
True
```

如果将逻辑值转换成整数类型，则False等于0，True等于1. 有时候，有技巧的开发者会故意使用这条规则作统计。例如学生做了10道题，这些题目的正确与否储存在一个列表里。

{% hint style="info" %}
**列表：**概念将在“数据结构”中讲到，它相当于一系列元素的组合。

我们现在只需知道，列表通常写作以下形式

```
x = [True, True, False, ...]
```

列表中元素的标号从0开始，以正整数递增，例如第一个元素记作x\[0].
{% endhint %}

如果想统计学生的正确率，只需写

```
score = sum(x) / len(x)
```

其中sum()函数表示对列表求和，len()函数表示求列表的长度。当x中都是布尔值时，没有必要单独用语句将True, False判断和计分，直接用求和操作时，True, False就会被自动转换成1, 0.

整数类型的变量能表示数学上的整数集，在Python语言中没有整型和长整型的区分，可以认为整数类型变量的表示范围是无界的。定义一个整数的语句是：

```
x = -1
```

而浮点数类型的变量能表示数学上的实数集。整数和浮点数结合起来，可以表示初等数学中的所有算术公式，其中进行运算的值可以是整数值或浮点数值，也可以是整数或浮点数类型的变量，四则运算的符号是`+ - * /`，例如用Python语言求一元二次方程$$ax^2+bx+c=0$$的根，可以编写如下程序：

```
from math import *

a, b, c = ...

x1 = (-b + sqrt(b**2 – 4*a*c)) / a / 2
x2 = (-b - sqrt(b**2 – 4*a*c)) / a / 2
```

{% hint style="info" %}
在Python语言中，浮点数（默认精度是64位双精度）的计算有截断误差，这是因为任意实数可以表示成 的形式，其中 ， ，计算机用1个字节（字节只有0和1两种取值）表示正负符号，11个字节用二进制表示 的数值，52个字节用二进制表示 ，结合起来保存浮点数。在运算时，在二进制中无限的小数被近似为有限小数，产生了误差，具体可参考 Python标准库的[https://docs.python.org/3/tutorial/floatingpoint.html](https://docs.python.org/3/tutorial/floatingpoint.html) 文档。值得注意的是，十进制和二进制中的无限小数不同，例如十进制有限小数0.2用二进制浮点数表示是$$0.2 = 2^{-3} + 2^{-4} + 2^{-7} + 2^{-8} + ... = 1.100110... \times 2^{-3}$$.

显示Python浮点数计算的截断误差，有一个典型的例子：

```
>>> 0.1 + 0.1 + 0.1
0.30000000000000004
```
{% endhint %}

特别地，以下数学运算的书写习惯，Python语言和数学不同：

**乘方：**在数学上，纯文本格式的乘方符号写作^（例如在Latex排版软件中就是这么定义），而Python语言的乘方符号是\*\*，例如

```
MSE = (y_hat – y) ** 2
```

**整数除法：**在小学数学中有“除不尽”的概念，小学生会把10/3写作

$$
10 \div 3 = 3 ... 1
$$

等号右边的3是整除结果，1称为余数。在数论中整除结果被定义为实数10/3的向下取整，1被定义为mod(10,3). 在Python语言中有

```
>>> 10 // 3
3
>>> 10 % 3
1
```

写成一般化的形式：

```
>>> x1 = a // b  # 其中a, b均为整数, 不限正负
>>> x2 = a % b
>>> a == x1*b + x2
True
```

x1始终是向下取整的；在数学上我们通常不讨论负数的整除性质，而在Python中规定，如果a, b同负使得a // b为正数，正常向下取整；如果ab<0使得a // b为负数，仍然取不大于a/b的最大整数，而不是趋零取整。

{% hint style="info" %}
这里体现出Python语言和C语言的不同，在C99语言标准之后，C语言的整除始终是趋零取整的。
{% endhint %}

使用函数库math可以计算

**三角函数：**sin(), cos(), tan(), sinh(), cosh(), tanh(), arcsin(), arccos(), arctan()

**指数和对数函数：**exp(), log(), log2(), log10()

**开方运算：**sqrt()

函数的写法和数学上相似。特别地，乘方运算的幂可以是任意实数，所以若需要开立方，可以直接操作x\*\*(1/3), 而不必困惑于没有在math函数库找到开立方的函数。对数函数log()的底数是自然指数e，如果要用除了e, 2, 10的其他底数，也没有对应的函数。此时请使用换底公式，将对数表示成2个自然对数的商。

一个实用的程序一定要有输出，而不是让使用者从内存中寻找x1, x2的值。回顾之前计算一元二次方程的例子，如果我们需要在屏幕上显示方程的根，最好使用字符串变量。

```
solution = f"一元二次方程{a}x^2+{b}x+{c}=0方程的根分别是{x1}和{x2}。"
print(solution)
```

solution是一个字符串变量，屏幕上显示的结果是：

```
一元二次方程2.0000x^2+4.0000x+3.0000=0方程的根分别是-1.0000和-3.0000。
```

如果要保留指定的小数位数，则应使用round函数对数值四舍五入，例如round(a, 2)将变量a的数值保留2位小数。

字符串变量是一段文本，定义时写在一对双引号或单引号之间，例如

```
x1 = "Hello, world!"
x2 = 'Hello, world!'
```

字符串中可以随处插入其他类型的**可以转化成字符串的变量**，其他变量用大括号括起，在双引号之前写一个字母f，此时字符串被称为f-string.

{% hint style="info" %}
f-string是Python 3.8中引入的新功能，以前的Python字符串中如果要插入变量，有许多不同的方式，例如

```
>>> "我的量化投资实务成绩是%d分。".format(score)
>>> "我的量化投资实务成绩是" + str(score) + "分。"
```

而f-string是更直观也是更快速的。被大括号括起的变量，如果不是字符串，会自动调用所属类型中的`__str__()`方法转换成字符串，效果相当于str()函数。我们已经多次看到“Python中一切皆为对象”，整数、浮点数、布尔值分别是int, float, bool类的实例，也分别有`__str__()`方法，例如

```
>>> 1.__str__()
'1'
>>> str(1)
'1'
```

百分号之后的字母是不同格式的代号，例如整数是%d，保留2位小数的浮点数是%.2f，科学计数法是%e.
{% endhint %}

那如果字符串有需要在屏幕上显示大括号，Python解释器会不会把它当作插入其他变量的标记？无疑是会的，所以在f-string中输入大括号要加上转义字符“反斜杠”，我们观察以下例子：

```
>>> z = 1
>>> f"集合A只有一个元素，结果是\{{1}\}."
集合A只有一个元素，结果是{1}.
```

外层的大括号表示在屏幕上输出文本括号，它们的前面分别有一个反斜杠；内层的大括号前面没有紧邻着反斜杠，所以表示取变量。除此以外，还有一些特殊的字符不可以用键盘输入，因此要输入它们时也要使用转义符号，常用的有换行符和制表符\t.

更一般地，当我们在双引号定义的字符串中使用单引号，或在单引号定义的字符串中使用双引号，不需要作任何处理，例如

```
x3 = "Jack's cat ate a fish last night."
```

{% hint style="info" %}
使用中文格式的引号“”和‘’也不需要作任何特殊处理。
{% endhint %}

但有时我们不可避免地需要同时使用英文的单引号和双引号，这时候如果不作处理，Python会发现定义字符串的结构（单引号或双引号）没有对称匹配，因此无法正确识别程序语句。例如我们以单引号定义字符串时，应该对字符串内（语义上的）的单引号作转义，即在单引号前添加转义符号，例如

```
x4 = 'Jack\'s cat ate a fish last night.'
```

前面多次提到每个字符串都是str类的实例，所以继承了str的类方法（“继承”和“类方法”也将在面向对象部分才会详细讲到，现在你只需知道用法），常用的类方法可以参考以下例子

```
>>> phrase1 = 'It rains Cats and Dogs.'
>>> phrase1.upper()  # 全部大写
IT RAINS CATS AND DOGS.
>>> phrase1.lower()  # 全部小写
it rains cats and dogs.

>>> phrase2 = '  It costs $3000.  '
>>> phrase2.rstrip()  # 去除右侧空格
'  It costs $3000.'
>>> phrase2.lstrip()  # 去除左侧空格
'It costs $3000.  '
>>> phrase2.stripe()  # 两侧空格都去除
'It costs $3000.'
```

这些类方法为数据清洗带来了极大的便利。

最终字符串还是需要显示在屏幕上的，我们已经使用过多次print函数了。它也可以接受多个变量作为输入：向print函数传递多个变量时，输出的每个变量中间自动用空格分开，输出结束自动在末尾添加换行符。分隔每个变量和符号和末尾添加的符号可以自定义，例如

```
print("My age is:", age, sep='\t', end='')
```

在`sep=`之后填写自定义的变量之间的分隔符，在`end=`之后填写的是输出结束时添加的符号。

字符串也是一种特殊的列表，我们可以取字符串的长度：

```
>>> len('quick')
5
```

**加法运算：**将多个字符串连续拼在一起。（减法运算没有意义）

```
>>> 'quick' + 'dog'
>>> quickdog
```

**乘法运算：**重复书写一个字符多次，这在格式化输出中非常有用。

```
>>> '='*10 + ' DEBUG ' + '='*10
========== DEBUG ==========
```

我们尝试实现组合的变量计算，编写一个计算隐含波动率的脚本。

隐含波动率计算的公式是



$$
\begin{cases}
c = s\Phi(d_1) - ke^{-rt}\Phi(d_2) \\
d_1 = \frac{\ln {s \over k} - (r + {1 \over 2}\sigma^2) t}{\sigma \sqrt t} \\
d_2 = d_1 - \sigma \sqrt t
\end{cases}
$$

所以，程序是

```
# 看涨期权 BSM 定价公式
import math as m
from scipy.stats import norm  # 导入正态分布函数库

s = ...  # 自定义，标的现货价格
k = ...  # 行权价格
t = ...  # 有效期
r = ...  # SHIBOR利率
sigma = ...  # 隐含波动率

d1 = (m.log(s / k) + (r + .5 * sigma ** 2) * t) / (sigma * t ** .5)
d2 = d1 - sigma * t ** .5
c  = s * norm.cdf(d1) - k * m.exp(-r * t) * norm.cdf(d2)  # 期权现价
```
